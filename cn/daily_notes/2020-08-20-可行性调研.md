这几天做了进一步分析，本文档记录一些结论，分析 zkSwap 项目是否有 prohibitively 地不可行成分，包括技术和产品(用户体验)两个方面。

## 技术分析
至少对于 Uniswap AMM，zksnark 是可行的。

zkSwap 大概会分成几个模块：

1. zksnark 电路描述：即用一种 DSL，描述计算的过程。这种 DSL 表达能力会比较弱，不过简单的加减乘除条件循环，到稍微复杂一点的 hash / merkle tree / signature 都能做。会使用这种 DSL 描述 Uniswap 的 AMM 主要逻辑。在 zkSwap 的设计中，会有一棵巨大的全局 merkle tree，存每个账户的每种 token 的所有交易历史。DSL 会描述交易如何更改这颗 merkle tree。
2. operator：用户把所有买卖 order (包括买卖什么 token，价格，自己的签名等）发给 operator，operator 批量汇总，做 zksnark proof，然后把 (1) 这些交易细节，下面叫做pubdata （2）执行完这批交易之后的全局 merkle tree root (3) 证明执行正确性的 proof 都更新在链上。
3. solidity合约：部署在ETH上。逻辑是，每次验证过 zksnark 的计算后，把新的全局 merkle tree root 记在合约中，同时本批交易的信息（pubdata），也会存在链上。merkle tree root 会记在合约储存中，可读可写，但是 GAS 费高。pubdata，只是作为合约参数记在链上，合约不需要读，更不需要写，GAS 低。这些 pubdata 作用是能够**仅依据链上信息**重建所有交易历史， 方便第三方做 explorer，也使得整个系统奔溃时，用户可以用这些数据重建历史，算出正确的 merkle proof，把自己的钱提出来。 
4. explorer：从链上同步数据，用 pubdata replay 历史，能够算出所有账户/订单细节。



### 具体一些风险点和应对
#### zksnark 友好的椭圆曲线(ECC)和签名
BTC/ETH 原生的 ECC 签名（secp256k1），因为使用的底层有限域和 zksnark 常见的不一样，需要 bitwise emulate 大量除法/取模等运算，使得 secp256k1 inside zksnark 基本不可行。但是有一些新的椭圆曲线，例如 jubjub，和底层 zksnark 共用有限域，能够提供一套可行的椭圆曲线签名方案。不过这意味着用户有个 Layer2 地址，和他的 Layer1 ETH native 地址不一样。不过这个应该可以在 UX 层面处理好。不会太困扰用户。
#### Proof 生成时间较长
参考 zksync 的文档，他们每次往 ETH 主网提交数据，都需要 10min 左右。较新的 crypto proof 技术（非 groth16 和 plonk 这种传统的，而类似 redshift 这种），可能能做到 1min 量级。10min 数据才能上链，意味着浏览器节点同步链上数据，有 10min 的数据延迟，因此没办法基于浏览器节点建立 DEX，价格太滞后了。DEX必须对接 operator，需要拿到 operator 内存中正在处理的订单数据。因此，这 10min 的延迟，导致了 operator 和 DEX 这两个逻辑上可以解耦的模块，实现上必须强耦合在一起。operator/DEX 节点需要在**本地**维护过去 10min 暂时没有上链的交易和状态（流动性池，价格）。而且需要处理很多 corner case（如链重组etc），增加了不少工程上的复杂性。


## 产品分析

需要思考这个产品是否是成立的，可行的。目前 CEX(如Huobi) 和 DEX(如Uniswap) 都是可行的产品，和他们两对比，我们来分析 zkSwap 的优劣。

### 和 DEX 对比
优势不提，zkSwap 比起 Uniswap, 有哪些劣势呢？

Uniswap 除了 GAS 太高以外，用户体验是很好的。只需要发送一个交易，钱包里的卖的 Token 减少，买的 Token 增加。

DEX 的使用者可以分为几类：

1. 流动性提供者。特指 AMM DEX 中的给流动性池充值的人。
2. 投机者。期待币价翻 10 倍。钱放在自己钱包中，还是交易所中，对他们无所谓。
3. 跨所套利者。不同 DEX 间高频腾挪，赚 <5% 的低风险利润。
4. （所内高频做市商：因为 GAS 费太高， DEX 较少这种角色，主要在 CEX 中。）

上述三种人中，对于 1 和 2，使用 zkSwap 这种需要充币提币的基于账户式交易所，体验并无大的不同。对于 3，zkSwap 比较不友好，从合约提币，他们要出高于普通转账的 GAS。而且因为 zkrollup 会增加 1-10min 的提币延迟，对于套利者，很不友好。

对套利者不友好的影响是什么呢？正是套利者推动 DEX 中的价格，和其他市场（DEX & CEX）一致。套利成本高，会使得价格变动滞后。但是，投机者看到别的交易所价格变化，也会跟着买卖，也可以所内推动价格趋于正确价格。此外，zkSwap 矿工费极低，（只要 zkSwap 不是毫无流量）高频做市商会被吸引来，快速买卖，跟踪正确价格。我认为，和 CEX 类似，zkSwap 对于跨所套利者的阻碍，能被对于高频做市商的鼓励抵消掉。 **zkSwap 应该没有价格发现的问题**。

### 和 CEX 对比
zkSwap 的用户体验，实际上接近一个更好的 CEX。
散户炒币体验角度来看，中心化交易所的劣势，汇总来说是几个方面：

1. 最火的币，上币要比 DEX 慢。
2. 如果用户平时的币较多在钱包中，那么他在 CEX 买币需要 充币-买卖-提币，很麻烦。
3. 安全性：需要 KYC ，而且交易所有跑路风险。

上述劣势中，zkSwap 可以克服 1 和 3，不能克服 2。用户体验接近一个 无需 KYC，资金绝对安全，没有上币门槛 的小所，是一个更好的 CEX。比起 CEX，zkSwap 的优势在于 1 3 两点，1 是新散户加入的关键，3 更锦上添花一点。

### 附：为什么 Loopring 不太火
Orderbook 还是比 AMM 难以启动，难以吸引第一波流动性进来。在小流量的情况下，更难以成交。我这方面思考不够有把握，欢迎大家给更多想法。

## 星辰大海和宏大叙事
上面的设计中，只有一个 operator，并且 operator 和 DEX 是耦合在一起的。

未来，可以建立一个 p2p network，所有加入这个 network 的人，会 p2p 地同步 orders，也都可以往主网提交 trades proof（用 round robin 或者 POS 决定谁提交）。这意味着谁都可以 setup 一个 zkSwap DEX 网站（后端 + 前端），而且是共享 orders 的。这条路线意味着更好的可用性，也对未来的治理/POS/生态铺平道路，确实是很多项目星辰大海的愿景与想象。但是这条道路意味着更大的技术工作量和风险，短期内不会去做。




